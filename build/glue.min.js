class Vec2{static from(e){return new Vec2(e.x,e.y)}static random(){return new Vec2(2*Math.random()-1,2*Math.random()-1)}constructor(e,t){this.x=e||0,this.y=t||0}add(e){return this.x+=e.x,this.y+=e.y,this}mult(e){return this.x*=e,this.y*=e,this}toString(){return this.x+", "+this.y}}class Point extends Vec2{static roughness=.5;bSkewed=!1;constructor(e,t){super(e,t),this.c=new Vec2(e,t)}reset(){this.bSkewed=!1,this.x=this.c.x,this.y=this.c.y}skew(e=1){return this.bSkewed=!0,this.x+=(2*Math.random()-1)*Point.roughness*e,this.y+=(2*Math.random()-1)*Point.roughness*e,this}}const range=(e,t,o)=>t+e*(o-t);class Primitive{constructor(e,t,o,s){this.p0=e,this.p1=t,this.control=o||new Point(range(.8,this.p0.x,this.p1.x),range(.8,this.p0.y,this.p1.y)),this.skewFactor=1}draw(e){e.moveTo(this.p0.x,this.p0.y),e.quadraticCurveTo(this.control.x,this.control.y,this.p1.x,this.p1.y)}skew(e){this.p0.bSkewed||this.p0.skew(this.skewFactor).add(e),this.p1.bSkewed||this.p1.skew(this.skewFactor).add(e),this.control.bSkewed||this.control.skew(3*this.skewFactor).add(e)}reset(){this.p0.reset(),this.p1.reset(),this.control.reset()}}class Drawable{constructor(t,e,o=1){this.points=[];for(let e=0;e<t.length;e+=2)this.points.push(new Point(t[e]*o,t[e+1]*o));this.parts=[],this.indC=e,this.buildParts(o)}buildParts(e){this.parts.length=0;for(const t of this.indC)3==t.length?this.parts.push(new Primitive(this.points[t[0]],this.points[t[1]],this.points[t[2]],e)):(this.parts.push(new Primitive(this.points[t[0]],this.points[t[1]],null,e)),.5<Math.random()&&this.parts.push(new Primitive(this.points[t[1]],this.points[t[0]],null,e)))}drawAt(e,t){e.beginPath();for(const o of this.parts)o.skew(t),o.draw(e);for(const s of this.parts)s.reset();e.stroke(),e.closePath()}}class Glyph{static create(e,t,o){e=Glyph.map[e]||Glyph.map[" "];return new Drawable(e[0],e[1],t,o)}static kerning={};static map={" ":[[7,0],[]],A:[[0,10,5,0,10,10,2.5,5,7.5,5],[[0,1],[1,2],[3,4]]],B:[[0,0,0,10,3,5,5,10,0,5,3,5,5,0],[[0,1],[1,2,3],[2,4],[5,0,6]]],C:[[5,0,-1,5,5,10,-1,0,-1,10],[[0,1,3],[1,2,4]]],D:[[0,0,0,10,5,5,5,10,5,0],[[0,1],[1,2,3],[2,0,4]]],E:[[7,0,0,0,0,5,5.5,5,0,10,7,10],[[0,1],[1,2],[2,3],[2,4],[4,5]]],F:[[7,0,0,0,0,5,5.5,5,0,10],[[0,1],[1,2],[2,3],[2,4]]],G:[[5,0,-1,5,2,10,5,5,2,5,7,5,-1,0,-1,10,5,10],[[0,1,6],[1,2,7],[2,3,8],[4,5]]],H:[[0,0,0,10,6,0,6,10,0,5,6,5],[[0,1],[2,3],[4,5]]],I:[[2,0,2,10,4,0],[[0,1]]],J:[[4,0,4,7,2,10,0,6,4,10,0,10],[[0,1],[1,2,4],[2,3,5]]],K:[[0,0,0,10,.5,5,4,0,4,10],[[0,1],[2,3],[2,4]]],L:[[0,0,0,10,6,10],[[0,1],[1,2]]],M:[[0,10,0,0,3.5,8,7,0,7,10],[[0,1],[1,2],[2,3],[3,4]]],N:[[0,10,0,0,5,10,5,0],[[0,1],[1,2],[2,3]]],O:[[4,0,0,5,4,10,8,5,0,0,0,10,8,10,8,0],[[0,1,4],[1,2,5],[2,3,6],[3,0,7]]],P:[[0,0,0,10,5,3.5,0,5,5,0,5,5],[[0,1],[0,2,4],[2,3,5]]],Q:[[4,0,0,5,4,10,8,5,0,0,0,10,8,10,8,0,9,10,4,6],[[0,1,4],[1,2,5],[2,3,6],[3,0,7],[8,9]]],R:[[0,0,0,10,5,3.5,0,5,5,0,5,5,5,10],[[0,1],[0,2,4],[2,3,5],[3,6]]],S:[[7,0,0,3.3,3.5,5.5,7,7,4.5,10,0,10,0,0,0,5.5,7,5.5,7,10],[[0,1,6],[1,2,7],[2,3,8],[3,4,9],[4,5]]],T:[[0,0,8,0,4,0,4,10],[[0,1],[2,3]]],U:[[0,0,0,7,4,10,8,7,8,0,0,10,8,10],[[0,1],[1,2,5],[2,3,6],[3,4]]],V:[[0,0,4,10,8,0],[[0,1],[1,2]]],W:[[0,0,0,10,3.5,2,7,10,7,0],[[0,1],[1,2],[2,3],[3,4]]],X:[[0,0,8,10,0,10,8,0],[[0,1],[2,3]]],Y:[[0,0,3.5,5,3.5,10,7,0],[[0,1],[1,2],[3,1]]],Z:[[0,0,8,0,0,10,8,10],[[0,1],[1,2],[2,3]]],0:[[4,0,0,5,4,10,8,5,0,0,0,10,8,10,8,0,0,0,8,10],[[0,1,4],[1,2,5],[2,3,6],[3,0,7],[8,9]]],1:[[4,0,4,10,0,5,2,10,6,10],[[0,1],[2,0],[3,4]]],2:[[0,2,2,0,8,3,6,6,0,10,8,10,8,0,8,5,0,1],[[0,1,8],[1,2,6],[2,3,7],[3,4],[4,5]]],3:[[0,2.5,3,0,6,2.5,3,5,6,7.5,3,10,0,7.5,0,0,6,0,6,5,6,10,0,10],[[0,1,7],[1,2,8],[2,3,9],[3,4,9],[4,5,10],[5,6,11]]],4:[[0,6,9,6,7,0,7,10],[[0,1],[0,2],[2,3]]],5:[[8,0,0,0,0,5,8,7.5,0,10,8,5,8,10],[[0,1],[1,2],[2,3,5],[3,4,6]]],6:[[8,2,6,0,0,5,5,10,7,6,4,4,0,7,8,0,0,0,0,10,7,10,7,4,2,4],[[0,1,7],[1,2,8],[2,3,9],[3,4,10],[4,5,11],[5,6,12]]],7:[[0,0,8,0,2,10,1,4.5,8,4.5,3,4],[[0,1],[1,2,5],[3,4]]],8:[[0,2,2,0,8,2,0,6,4,10,8,6,0,0,8,0,0,10,8,10],[[0,1,6],[1,2,7],[2,3],[3,4,8],[4,5,9],[5,0]]],9:[[3,0,0,3,3,6,6,3,0,0,0,6,6,6,6,0,6,7,2,10,6,10],[[0,1,4],[1,2,5],[2,3,6],[3,0,7],[3,8],[8,9,10]]],"-":[[0,6,4,6],[[0,1]]],"+":[[0,6,4,6,2,4,2,8],[[0,1],[2,3]]],",":[[1.3,9,0,13],[[0,1]]],"°":[[0,2,2,0,4,2,2,4,0,0,4,0,4,4,0,4],[[0,1,4],[1,2,5],[2,3,6],[3,0,7]]],".":[[0,9,1,10,2,9,1,8,0,10,2,10,2,8,0,8],[[0,1,4],[1,2,5],[2,3,6],[3,0,7]]],"\0":[[0,0,10,0,10,10,0,10,1,8,3,10,4,10,5,9,2.5,6.5,3.5,5.5,7.5,1.5,6,8,10,4],[[0,1],[1,2],[2,3],[3,0],[4,5],[6,7],[7,8],[4,8],[9,10],[9,11],[11,12],[10,12]]],"":[[4,5,5,4,6,5,5,6,4,4,6,4,6,6,4,6,3,5,0,5,4,3,1,1,0,2,7,5,10,5,6,3,9,1,10,1,4,7,2.5,9,6,7,7.5,9,5,10],[[0,1,4],[1,2,5],[2,3,6],[3,0,7],[8,9],[10,11],[8,10],[9,11,12],[13,14],[15,16],[13,15],[14,16,17],[18,19],[20,21],[18,20],[19,21,22]]],"":[[4,0,7,0,2,5,4,5,3,10,7,4,5,4],[[0,1],[0,2],[2,3],[3,4],[4,5],[5,6],[6,1]]],"":[[3,10,0,7,1.57,4.34,4.78,9.25,0,10,3.62,10.24,-.08,4.97,1.9,4.56,1.43,-.06,1.92,5.02,2.8,-.03,5.53,-.02,2,6.05,4.38,-.16,2.41,5.22,8.83,-.05,2.66,6.58,7.53,-.03,2.48,6.03,9.48,-.1,2.93,7.18,2.56,7.61,10.08,.73,10.16,3.95,3.68,8.34,10.22,2.16,3.12,7.93,4.17,8.6,11.41,5.13,4.7,8.8,9.96,7.13,9.35,8.93,4.81,9],[[0,1,4],[1,2,6],[0,3,5],[7,8],[9,10],[11,12],[13,14],[15,16],[17,18],[19,20],[21,22],[23,24],[25,26],[27,28],[29,30],[31,32]]],"":[[5,0,2,7,8,7,5,10,2,10,8,10,10,0],[[0,1],[0,2],[1,3,4],[2,3,5]]],"":[[5,5,1,10,9,10,3,4,3.5,4,3.5,4.5,3,4.5,7.3,3,7.8,3,7.8,3.5,7.3,3.5,4.3,1.7,4.8,1.7,4.8,2.2,4.3,2.2],[[0,1],[1,2],[2,0],[3,4],[4,5],[5,6],[6,3],[7,8],[8,9],[9,10],[10,7],[11,12],[12,13],[13,14],[14,11]]],"":[[0,0,0,10,10,10,10,0,2,2,8,2,8,8,2,8],[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4]]],"":[[.01,3,2.41,.57,4.41,1.4,6.82,2.98,.71,.76,3.57,.38,10.05,.22,5.32,2.91,9.44,2.37,4.25,7.35,2.24,6.25,3.74,6.25,0,9.04,6.78,8.96,.56,6.63,10.01,6.3,5.02,8.97,9.54,8.83,7.98,6.18],[[0,1,4],[1,2,5],[2,3,7],[3,6,8],[9,10,11],[10,12,14],[9,13,16],[15,13,17]]],"\b":[[0,0,0,10,10,10,10,0,8,1,9,2,7,2,8,3,2,7,3,8,8,1,9,2,1,9],[[0,1],[1,2],[2,3],[3,0],[4,5],[4,6],[6,7],[7,5],[8,9],[8,10],[9,11],[8,12],[9,12]]],"\t":[[0,0,0,10,10,10,10,0,0,4,10,4,1,4,1,5,3,4,3,5,5,4,5,6,7,4,7,5,9,4,9,5,0,6,10,6],[[0,1],[1,2],[2,3],[3,0],[4,5],[6,7],[8,9],[10,11],[12,13],[14,15],[16,17]]],"":[[0,0,0,10,10,10,10,0,2,8,8,2,5,2,8,5],[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[5,7]]],"":[[0,0,0,10,10,10,10,0,2,2,4,2,4,8,2,8,6,2,8,2,8,8,6,8],[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[8,9],[9,10],[10,11],[11,8]]],"":[[0,0,0,10,10,10,10,0,3,2.5,8,5,3,7.5],[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,4]]],"":[[0,0,0,10,10,10,10,0,5,2,8,5,5,8,2,5,8,2,8,8,2,8,2,2,3,6,3,9,5.7,8],[[0,1],[1,2],[2,3],[3,0],[4,5,8],[6,7,10],[7,4,11],[14,12],[14,13]]],"":[[0,0,0,10,10,10,10,0,8,2,2,8,6,2,8,4,4,8,2,6],[[0,1],[1,2],[2,3],[3,0],[4,5],[4,6],[4,7],[5,8],[5,9]]],"":[[0,0,0,10,10,10,10,0,5,2,8.7,5,5,8,2,2,4,2,4,8,2,8],[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,4],[7,8],[8,9],[9,10],[10,7]]],"²":[[0,2,2,0,8,3,6,6,0,10,8,10,8,0,8,5,0,1].map((e,t)=>.4*e+(t%2==0?1.5:0)),[[0,1,8],[1,2,6],[2,3,7],[3,4],[4,5]]]}}for(const H in Glyph.map){const[I]=Glyph.map[H];let t=0;for(let e=0;e<I.length;e+=2)I[e]>t&&(t=I[e]);Glyph.kerning[H]=t}class EventHandler{hoveringInPreviousTick=[];mx=-1;my=-1;isPhone=!1;constructor(){window.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("mousemove",e=>{this.isPhone||(this.mx=e.clientX,this.my=e.clientY,this.tick())}),window.addEventListener("mousedown",t=>{if(!this.isPhone){this.mx=t.clientX,this.my=t.clientY;let e=!1;for(const s of renderList)s.onmousedown&&s.visible&&s.pointInBoundary(this.mx,this.my)&&(s.onmousedown.apply(s,[t]),e=!0);const o=tools[0==t.button?0:1];o&&!e&&this.inCanvas()&&o.ondown(this.getCanvasCoords())}}),window.addEventListener("mouseup",e=>{if(!this.isPhone){this.mx=e.clientX,this.my=e.clientY;const t=tools[0==e.button?0:2==e.button?1:2];t&&t.onup(this.getCanvasCoords())}}),window.addEventListener("touchstart",e=>{this.isPhone=!0,this.mx=e.changedTouches[0].clientX,this.my=e.changedTouches[0].clientY;let t=!1;for(const s of renderList)s.onmousedown&&s.visible&&s.pointInBoundary(this.mx,this.my)&&(s.onmousedown.apply(s,[{button:0,clientX:this.mx,clientY:this.my}]),t=!0);const o=tools[0];o&&!t&&this.inCanvas()&&o.ondown(this.getCanvasCoords())}),window.addEventListener("touchmove",e=>{this.isPhone=!0,this.mx=e.changedTouches[0].clientX,this.my=e.changedTouches[0].clientY,this.tick()}),window.addEventListener("touchend",e=>{this.isPhone=!0,this.mx=e.changedTouches[0].clientX,this.my=e.changedTouches[0].clientY;const t=tools[0];t&&t.onup(this.getCanvasCoords())}),window.addEventListener("keypress",e=>{/[1-5]/.test(e.key)?wasm.exports.changeScene(+e.key):!(e={d:"tool_draw",e:"tool_erase",l:"tool_line",w:"tool_wind"," ":"control_pause",s:"control_step",r:"control_reset",c:"control_resize"}[e.key.toLowerCase()])||(e=Element.getElementIndexById(e))&&renderList[e].onmousedown({button:0})}),window.addEventListener("wheel",e=>{renderList[Element.getElementIndexById("tool_areaOfEffect")].onmousedown({button:e.deltaY<0?0:2})})}inCanvas(){var{top:e,left:t,right:o,bottom:s}=canvas.getBoundingClientRect();return this.mx>t&&this.mx<o&&this.my>e&&this.my<s}getCanvasCoords(){var{left:e,top:t,width:o,height:s}=canvas.getBoundingClientRect();return{x:(this.mx-e)*(canvas.width/o)|0,y:(this.my-t)*(canvas.height/s)|0}}tick(){const o=[];let e=!1;for(const s of renderList)s.pointInBoundary(this.mx,this.my)&&(o.push(s),s.visible&&!s.id.startsWith("bounding_")&&(e=!0));e:for(let t=0;t<this.hoveringInPreviousTick.length;++t)if(this.hoveringInPreviousTick[t].onmouseexit&&this.hoveringInPreviousTick[t].visible){for(let e=0;e<o.length;++e)if(o[e]==this.hoveringInPreviousTick[t])continue e;this.hoveringInPreviousTick[t].onmouseexit.apply(o[t],o[t])}e:for(let t=0;t<o.length;++t)if(o[t].onmouseenter&&o[t].visible){for(let e=0;e<this.hoveringInPreviousTick.length;++e)if(o[t]==this.hoveringInPreviousTick[e])continue e;o[t].onmouseenter.apply(o[t],o[t])}if(!e&&this.inCanvas()){var t=this.getCanvasCoords();for(const n of tools)n.ontick(t)}this.hoveringInPreviousTick=o}}class Element{static getElementIndexById(t){for(let e=0;e<renderList.length;++e)if(renderList[e].id==t)return e;return null}left;right;top;bottom;id="unknown";get width(){return this.right-this.left}get height(){return this.bottom-this.top}get visible(){return this._visible}set visible(e){return this._visible=!!e}constructor(e){this.pivot=Vec2.from(e),this._visible=!0}pointInBoundary(e,t){return e>this.left&&e<this.right&&t>this.top&&t<this.bottom}on(e,t){this["on"+e]=t}}let frameExplosionPower=0;function line(e,t,o,s,n){var i=Math.abs(o-e),r=-Math.abs(s-t),a=e<o?1:-1,c=t<s?1:-1;let l=i+r;for(;;){if(n(e,t),e==o&&t==s)return;var h=2*l;r<=h&&(l+=r,e+=a),h<=i&&(l+=i,t+=c)}}(()=>{const a=document.getElementById("ui"),c=a.getContext("2d");window.renderList=[],setInterval(()=>{if(void 0!==wasm&&void 0!==infoNode){let e="0",t="VOID";var{x:o,y:s}=eventhandler.getCanvasCoords();eventhandler.inCanvas()&&(e=wasm.exports.getTemp(o,s).toFixed(1),t=enumToString[wasm.exports.getType(wasm.exports.getCell(o,s))]);s=`${o}x, ${canvas.height-s}y, ${e}°C, `+t;infoNode.changeText(s),frameExplosionPower<1?(frameExplosionPower=0,TextNode.shake=0,Point.roughness=0):(TextNode.shake=Math.min(25,frameExplosionPower/10),Point.roughness=10,frameExplosionPower*=.8),Point.roughness=Math.min(3,Math.max(0,e/250+.48))+frameExplosionPower/1e3,c.clearRect(0,0,a.width,a.height);for(const i of renderList)i.visible&&i.draw(c);var n=Math.min(.7,wasm.exports.getNSubatomics()/15e3);if(n){const r=c.getImageData(0,0,a.width,a.height);for(let e=3;e<r.data.length;e+=4)r.data[e]&&Math.random()<n&&(r.data[e]=0);c.putImageData(r,0,0)}}},50),window.addEventListener("resize",()=>{a.width=window.innerWidth,a.height=window.innerHeight,c.strokeStyle="#ffffff",renderList.length=0,window.constructUI(renderList)}),window.addEventListener("load",()=>{a.width=window.innerWidth,a.height=window.innerHeight,c.strokeStyle="#ffffff",renderList.length=0})})();class TextNode extends Element{static shake=0;constructor(e,t,o,s="left"){super(o),this.scale=t,this.justify=s,this._text="",this.changeText(e),this._text=e}changeText(t){if(t!=this._text){const n=(this._text=t).toUpperCase().split("\n");this.glyphs=[];let e=0;for(let o=0;o<n.length;++o){let t=0;for(let e=0;e<n[o].length;++e){var s=n[o].charAt(e);this.glyphs.push({drawable:Glyph.create(s,this.scale),pivot:new Vec2(t,0)}),t+=Glyph.kerning[s]*this.scale+2}t>e&&(e=t)}this.left=this.pivot.x,this.right=this.pivot.x+e,this.top=this.pivot.y,this.bottom=this.pivot.y+10*n.length*this.scale;var o=this.width;switch(this.justify){case"right":this.left-=o,this.right-=o;break;case"center":this.left-=o/2,this.right-=o/2}}}draw(e){this.clr&&(e.strokeStyle=this.clr);for(const t of this.glyphs)t.drawable.drawAt(e,new Vec2(this.left,this.top).add(t.pivot).add(Vec2.random().mult(TextNode.shake)));this.clr&&(e.strokeStyle="#ffffff")}}class Button extends Element{constructor(e,t,o){super(o);var s=4*t;this.label=new TextNode(e,t,new Vec2(o.x+s,o.y+s)),this.border=new Drawable([0,0,this.label.width+2*s,0,this.label.width+2*s,this.label.height+2*s,0,this.label.height+2*s],[[0,1],[1,2],[2,3],[3,0]]),this.left=this.label.left-s,this.right=this.label.right+s,this.top=this.label.top-s,this.bottom=this.label.bottom+s}draw(e){this.clr&&(e.strokeStyle=this.clr),this.label.draw(e),this.border.drawAt(e,this.pivot),this.clr&&(e.strokeStyle="#ffffff")}}class PaintTool{pressed=!1;mx=-1;my=-1;ondown({x:e,y:t}){this.mx=e,this.my=t,this.pressed=!0,this.applyPaint(this.mx,this.my)}onup(){this.pressed=!1}ontick({x:e,y:t}){this.pressed&&(line(this.mx,this.my,e,t,this.applyPaint),this.mx=e,this.my=t)}applyPaint(e,t){return wasm.exports.applyPaint(e,t,elementInBrush,areaOfEffect)}}class EraseTool{pressed=!1;mx=-1;my=-1;ondown({x:e,y:t}){this.mx=e,this.my=t,this.pressed=!0,this.applyPaint(this.mx,this.my)}onup(){this.pressed=!1}ontick({x:e,y:t}){this.pressed&&(line(this.mx,this.my,e,t,this.applyPaint),this.mx=e,this.my=t)}applyPaint(e,t){return wasm.exports.eraseArea(e,t,areaOfEffect)}}class LineTool{drawing=!1;anchorX=-1;anchorY=-1;tAX=-1;tAY=-1;mx=-1;my=-1;constructor(){var e=Element.getElementIndexById("tool_line_draw");null!=e?this.el=renderList[e]:(this.el=new Element(new Vec2),this.el.id="tool_line_draw",renderList.push(this.el)),this.el.draw=e=>{this.drawing&&new Drawable([this.anchorX,this.anchorY,this.mx,this.my],[[0,1]],1).drawAt(e,new Vec2)}}ondown({x:e,y:t}){this.tAX=e,this.tAY=t,this.mx=eventhandler.mx,this.my=eventhandler.my,this.anchorX=this.mx,this.anchorY=this.my,this.drawing=!0}onup({x:e,y:t}){this.drawing=!1,-1!=this.tAX&&-1!=this.tAY&&line(this.tAX,this.tAY,e,t,this.applyPaint),this.tAX=-1,this.tAY=-1}ontick({}){this.mx=eventhandler.mx,this.my=eventhandler.my}applyPaint(e,t){wasm.exports.applyPaint(e,t,elementInBrush,areaOfEffect)}}class WindTool{pressed=!1;mx=-1;my=-1;ondown({x:e,y:t}){this.mx=e,this.my=t,this.pressed=!0}onup(){this.pressed=!1}ontick({x:e,y:t}){if(this.pressed){let o=this.mx,s=this.my;line(this.mx,this.my,e,t,(e,t)=>{wasm.exports.fluidVelocity(e,t,(e-o)*areaOfEffect*2.5,(t-s)*areaOfEffect*2.5+1),o=e,s=t}),this.mx=e,this.my=t}}}const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");let wasm,__memoryLen=0,imageData,areaOfEffect=3,elementInBrush,paused=!1,categorySelected="brittle";function setSize(e){canvas.width=75*e,canvas.height=75*e,wasm.exports.setSize(canvas.width,canvas.height);e=createView("Uint8Clamped","imageData",canvas.width*canvas.height*4,!0);imageData=new ImageData(e,canvas.width,canvas.height)}const toolList=[{name:"draw",symbol:"\b",constructor:PaintTool},{name:"erase",symbol:"\0",constructor:EraseTool},{name:"line",symbol:"\t",constructor:LineTool},{name:"wind",symbol:"",constructor:WindTool}],tools=[new PaintTool,new EraseTool],toolColors=["#ffd9b5","#b5f1ff"];let resizeMenuOpen=!1;const controls=[{name:"pause",symbol:"",callback(e,t){paused=!paused,e.changeText(paused?"":""),t.changeText(paused?"RESUME":"PAUSE")}},{name:"step",symbol:"",callback(){wasm.exports.tick()}},{name:"reset",symbol:"",callback(){wasm.exports.changeScene()}},{name:"resize",symbol:"",callback(){if(resizeMenuOpen)renderList[Element.getElementIndexById("resizeMenuCancel")].onmousedown();else{resizeMenuOpen=!0;var{top:s,left:n,right:i,bottom:r}=canvas.getBoundingClientRect(),a=window.innerWidth<620?range(window.innerWidth/620,.1,1.5):2;const l=new TextNode("Resize canvas",1.8*a,new Vec2(n+(i-n)/2,s+(r-s)/2-60*a),"center");renderList.push(l);let t=0;var c=[1,2,4,6,8,10,15,20];for(let e=0;e<c.length;++e)t+=new Button(75*c[e]+"²",+a,new Vec2).width+4*a;let o=0;const h=[];for(let e=0;e<c.length;++e){const m=c[e],u=new Button(75*c[e]+"²",+a,new Vec2(n+(i-n)/2+o-t/2,s+(r-s)/2-20*a));u.on("mouseenter",()=>{document.body.style.cursor="pointer"}),u.on("mouseexit",()=>{document.body.style.cursor="default"}),u.on("mousedown",()=>{setSize(m),renderList[Element.getElementIndexById("resizeMenuCancel")].onmousedown()}),o+=u.width+4*a,renderList.push(u),h.push(u)}var e=new Button("cancel",+a,new Vec2).width;const d=new Button("cancel",+a,new Vec2(n+(i-n)/2-e/2,s+(r-s)/2+5*a));d.id="resizeMenuCancel",d.on("mouseenter",()=>{document.body.style.cursor="pointer"}),d.on("mouseexit",()=>{document.body.style.cursor="default"}),d.on("mousedown",()=>{resizeMenuOpen=!1,renderList.splice(renderList.indexOf(d),1),renderList.splice(renderList.indexOf(l),1);for(const e of h)renderList.splice(renderList.indexOf(e),1)}),renderList.push(d)}}}],eventhandler=new EventHandler;let infoNode;function createView(e,t,o,s=!1){t=wasm.exports[t].value;return new window[e+"Array"](wasm.exports.memory.buffer,s?new Uint32Array(wasm.exports.memory.buffer,t,1)[0]:t,o||1)}function loop(){requestAnimationFrame(loop),eventhandler.tick(),__memoryLen&&wasm.exports.memory.buffer.byteLength!=__memoryLen&&(e=createView("Uint8Clamped","imageData",canvas.width*canvas.height*4,!0),imageData=new ImageData(e,canvas.width,canvas.height)),__memoryLen=wasm.exports.memory.buffer.byteLength,wasm.exports.draw(),paused||wasm.exports.tick(),ctx.putImageData(imageData,0,0);var e=wasm.exports.getFrameExplosionPower();e>frameExplosionPower&&(frameExplosionPower=e)}function generateFavicon(e){const t=document.createElement("canvas").getContext("2d");t.canvas.width=32,t.canvas.height=32,t.strokeStyle="#ffffff",Glyph.create(e,3,new Vec2).drawAt(t,new Vec2(1,1)),document.getElementById("favicon").href=t.canvas.toDataURL("image/png",10)}window.constructUI=a=>{resizeMenuOpen=!1;let s=lookup[enumToString[elementInBrush]].name||enumToString[elementInBrush];const{top:c,left:l,right:e,bottom:t}=canvas.getBoundingClientRect(),h=Math.min(window.innerWidth)<620?range(Math.min(window.innerWidth)/620,.1,1.5):2;let d=8;for(const f in categories)if("pseudo"!=f&&"hidden"!=f){const y=new TextNode(catSymbols[categories[f]],h,new Vec2(l+d,c-13*h));y.id="cat_"+f;const x=[];let e=0,i=0,r=0;for(const v in lookup){const b=lookup[v];if(b.category==categories[f]){let t=d;const E=new Button(b.name||v,h,new Vec2(l+d-2*h,c+e));(b.name||v)==s&&(E.clr=toolColors[0]),E.id="elementselect_"+(b.name||v),E.visible=!1;let o=e;E.on("mousedown",()=>{var e=Element.getElementIndexById("elementselect_"+s);null!=e&&delete a[e].clr;e=Element.getElementIndexById("cat_"+categorySelected);null!=e&&delete a[e].clr,elementInBrush=b.id,E.clr=toolColors[0],s=b.name||v,categorySelected=f,y.clr=toolColors[0],a[Element.getElementIndexById("bounding_"+f)].onmouseexit(),generateFavicon(catSymbols[categories[f]]),E.onmouseexit()}),E.on("mouseenter",()=>{if(document.body.style.cursor="pointer",!eventhandler.isPhone){const e=new TextNode(lookup[v].description,.8*h,new Vec2(E.width+l+t+8*h,c+o+5*h));e.id="description_"+v,a.push(e)}}),E.on("mouseexit",()=>{document.body.style.cursor="default",eventhandler.isPhone||a.splice(Element.getElementIndexById("description_"+v))}),E.bottom>r&&(r=E.bottom),E.right>i&&(i=E.right),e+=E.height+4*h,a.push(E),x.push(E)}}y.on("mouseenter",()=>{if(!Element.getElementIndexById("bounding_"+f)){for(const s in categories){var e=Element.getElementIndexById("bounding_"+s);null!=e&&a[e].onmouseexit()}for(const n of x)n.visible=!0;const o=new TextNode(f,h,new Vec2(l+d+16*h,c-13*h));a.push(o);const t=new Element(new Vec2);t.draw=()=>{},t.id="bounding_"+f,t.top=-100,t.left=l-8,t.right=i+8,t.bottom=r+8,t.on("mouseexit",()=>{var e=Element.getElementIndexById("bounding_"+f);if(null!=e){for(const t of x)t.visible=!1;a.splice(e,1),a.splice(a.indexOf(o),1)}}),a.push(t)}}),d+=y.width+4*h,a.push(y)}let o;const n=new TextNode("Tool Strength",1.8,new Vec2(l+4*h,c+2*h*1.8));n.visible=!1;const i=new Element(new Vec2);i.id="tool_areaOfEffect",i.right=l-2,i.left=i.right-18*h-5,i.top=c,i.bottom=c+18*h,i.draw=e=>{o.drawAt(e,new Vec2(l-3*h-18*h,c))},i.on("mouseenter",()=>{document.body.style.cursor="pointer",n.visible=!0}),i.on("mouseexit",()=>{document.body.style.cursor="default",n.visible=!1}),i.on("mousedown",e=>{let t;if(0==e.button)switch(areaOfEffect){case 0:areaOfEffect=3,t=.7142857142857143;break;case 3:areaOfEffect=5,t=1.4285714285714286;break;case 5:areaOfEffect=7,t=2.142857142857143;break;case 7:areaOfEffect=10,t=2.857142857142857;break;case 10:areaOfEffect=15,t=3.5714285714285716;break;case 15:areaOfEffect=30,t=4.285714285714286;break;case 30:areaOfEffect=50,t=5;break;case 50:areaOfEffect=0,t=0}else switch(areaOfEffect){case 0:areaOfEffect=50,t=5;break;case 3:areaOfEffect=0,t=0;break;case 5:areaOfEffect=3,t=.7142857142857143;break;case 7:areaOfEffect=5,t=1.4285714285714286;break;case 10:areaOfEffect=7,t=2.142857142857143;break;case 15:areaOfEffect=10,t=2.857142857142857;break;case 30:areaOfEffect=15,t=3.5714285714285716;break;case 50:areaOfEffect=30,t=4.285714285714286}o=new Drawable([0,0,0,10,10,10,10,0,5+t,5,5,5+t,5-t,5,5,5-t,5+t,5+t,5-t,5+t,5-t,5-t,5+t,5-t],[[0,1],[1,2],[2,3],[3,0],[4,5,8],[5,6,9],[6,7,10],[7,4,11]],1.8*h)}),a.push(i,n),i.onmousedown({button:2}),i.onmousedown({button:0});let r=21*h*2,m=0;for(const k of toolList){const T=new TextNode(k.symbol,1.8*h,new Vec2(l-2*h,c+r),"right");k.node=T;let o=m;for(let e=0;e<2;++e)tools[e]instanceof k.constructor&&(tools[e]instanceof LineTool&&(tools[e]=new LineTool),T.clr=toolColors[e],tools[e].id=o);const I=new TextNode(k.name,h,new Vec2(l+4*h,c+r+3*h*1.8));I.visible=!1,a.push(I),T.on("mouseenter",()=>{document.body.style.cursor="pointer",I.visible=!0}),T.on("mouseexit",()=>{document.body.style.cursor="default",I.visible=!1}),T.on("mousedown",e=>{var t=0==e.button?0:1,e=+!t;!tools[t]||tools[t]instanceof k.constructor||(tools[e]instanceof k.constructor?(tools[e]=tools[t],"number"==typeof tools[e].id&&(toolList[tools[e].id].node.clr=toolColors[e])):"number"==typeof tools[t].id&&delete toolList[tools[t].id].node.clr,tools[t]=new k.constructor,tools[t].id=o,toolList[o].node.clr=toolColors[t])}),a.push(T),T.id="tool_"+k.name,r+=21*h,m+=1}r+=21*h*1;for(const P of controls){const L=new TextNode(P.symbol,1.8*h,new Vec2(l-2*h,c+r),"right"),O=new TextNode(P.name,h,new Vec2(l+4*h,c+r+3*h*1.8));O.visible=!1,L.on("mouseenter",()=>{document.body.style.cursor="pointer",O.visible=!0}),L.on("mouseexit",()=>{document.body.style.cursor="default",O.visible=!1}),L.on("mousedown",()=>{P.callback(L,O)}),a.push(L,O),L.id="control_"+P.name,r+=21*h}infoNode=new TextNode("-1x, -1y, 0.2°C, VOID",h,new Vec2(e-8,c-13*h),"right"),a.push(infoNode);const u=new TextNode("plop 1.0",h,new Vec2(l+8,t+4*h));u.on("mouseenter",()=>document.body.style.cursor="pointer"),u.on("mouseexit",()=>document.body.style.cursor="default"),u.on("mousedown",()=>window.open("https://github.com/Caltrop256/plop")),a.push(u);const p=new TextNode("caltrop.dev",h,new Vec2(e-8,t+4*h),"right");p.on("mouseenter",()=>document.body.style.cursor="pointer"),p.on("mouseexit",()=>document.body.style.cursor="default"),p.on("mousedown",()=>window.open("https://caltrop.dev/")),a.push(p);const g=new Drawable([l,c,e,c,e,t,l,t],[[0,1],[1,2],[2,3],[3,0]],1),w=new Element(new Vec2);w.draw=e=>{paused&&(e.strokeStyle="#ff0000"),g.drawAt(e,new Vec2),e.strokeStyle="#ffffff"},a.push(w),a[Element.getElementIndexById("cat_"+categorySelected)].clr=toolColors[0]},async function(){fetch("sim.wasm").then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,{env:{log:console.log,cos:Math.cos,sin:Math.sin,atan2:Math.atan2}})).then(({instance:e})=>{wasm=e;e=new Uint32Array(6);crypto.getRandomValues(e),readEnumArray(),elementInBrush=lookup.SAND.id,generateFavicon(catSymbols[2]),constructUI(renderList),wasm.exports.seed(...e),setSize(4),loop()})}();const categories={pseudo:0,solid:1,brittle:2,liquid:3,gas:4,electronics:5,explosives:6,nuclear:7,hidden:8},catSymbols=[,"","","","","","",""],lookup={VOID:{id:0,category:categories.pseudo,description:"gender"},EMPTY:{id:1,category:categories.pseudo},SAND:{category:categories.brittle,description:"the primordial element, turns into glass when heated"},DIRT:{category:categories.brittle,description:"its... dirt"},COAL:{category:categories.brittle,description:"burns predictably"},SNOW:{category:categories.brittle,description:"beautiful"},COBBLESTONE:{category:categories.brittle,description:"heavy"},SEED:{category:categories.brittle,description:"grows into plant on sand or dirt"},STONE:{category:categories.solid,description:"strong insolator"},WOOD:{category:categories.solid,description:"helps plants grow, turns into coal when burned"},TITANIUM:{category:categories.solid,description:"immune to acid, very explosion resistent"},PLANT:{category:categories.solid,description:"flammable, decomposes into dirt"},ICE:{category:categories.solid,description:"cold"},GLASS:{category:categories.solid,description:"refracts light"},FUNGUS:{category:categories.solid,description:"spreads through solids"},WATER:{category:categories.liquid,description:"freezes when cold, turns to steam when hot"},CEMENT:{category:categories.liquid,description:"cures into stone"},OIL:{category:categories.liquid,description:"burns with a lot of smoke"},MAGMA:{category:categories.liquid,description:"very hot."},ACID:{category:categories.liquid,description:"destroys most materials, creates toxic smoke"},LIQUIDNITROGEN:{category:categories.liquid,description:"very cold, evaporates on contact",name:"nitrogen"},STEAM:{category:categories.gas,description:"precipitates water or snow"},SMOKE:{category:categories.gas,description:"chokes flames"},FOG:{category:categories.gas,description:"exists until it doesnt"},TOXIC:{category:categories.gas,description:"flammable, very light"},SPARK:{category:categories.electronics,description:"electric spark"},BATTERY:{category:categories.electronics,description:"produces infinite electricity"},COPPER:{category:categories.electronics,description:"conducts electricity, heats up"},TORCH:{category:categories.electronics,description:"creates fire when powered"},CONVEYER:{category:categories.electronics,description:"moves material in the direction it conducts"},PISTON:{category:categories.electronics,description:"extends to the left, completes circuits"},PUMP:{category:categories.hidden,description:"doesnt work,,,"},LIGHTNING:{category:categories.electronics,description:"discharges into the ground, destructive"},FIRE:{category:categories.explosives,description:"hot, ignites flamamble material"},FUSE:{category:categories.explosives,description:"burns slowly, sparks"},GUNPOWDER:{category:categories.explosives,description:"cute and valid"},DYNAMITE:{category:categories.explosives,description:"stable, detonates when sparked"},FIREWORK:{category:categories.explosives,description:"shoots up into the air"},THERMITE:{category:categories.explosives,description:"burns hot and violently"},NITRO:{category:categories.explosives,description:"highly volatile, very destructive"},ELECTRON:{category:categories.nuclear,description:"messes with the internals of material"},PROTON:{category:categories.nuclear,description:"heats elements up"},NEUTRON:{category:categories.nuclear,description:"changes atomic makeup of material"},PHOTON:{category:categories.nuclear,description:"pretty colors,,,,"},POLONIUM:{category:categories.nuclear,description:"decays into neutrons and plutonium"},PLUTONIUM:{category:categories.nuclear,description:"decays quickly, detonates when hot"},CLONER:{category:categories.nuclear,description:"copies nearby elements"},UNBREAKABLECLONER:{name:"cloner++",category:categories.nuclear,description:"harder, better, faster, stronger"},PELLET:{category:categories.hidden},DEBRIS:{category:categories.hidden}};function readcstr(e){var t=new Uint8Array(wasm.exports.memory.buffer,e);let o=0,s="";for(;t[o];)s+=String.fromCharCode(t[o++]);return s}const enumToString=["VOID","EMPTY"];function readEnumArray(){var e=new Uint32Array(wasm.exports.memory.buffer,wasm.exports.enumToString.value);let t=0;for(;e[t];){var o=readcstr(e[t++]);lookup[o].id=t+1,enumToString[t+1]=o}}